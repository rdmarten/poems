<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>reflections</title>

  <!-- Tufte CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tufte-css/1.8.0/tufte.min.css"/>

  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

  <style>
    :root{
      --ink:#111;
      --bloom-grey:#b8b8b8; /* light grey */
    }
    body{ background:#fff; color:var(--ink); }
    .pi-tufte{ max-width:70ch; margin:0 auto; }
    .poem{ font-size:1.05rem; line-height:1.6; }
    .poem p{ margin:0.45rem 0; }

    /* visible-by-default */
    .reveal{ opacity:1; transform:none; }

    /* ensure consistent line sizing everywhere */
    .poem .line{ font-size:1em; }
    .poem .line .char{ font-size:inherit; }

    /* per-char */
    .char{ display:inline-block; will-change:transform, filter, color, opacity; }

    /* bloom targets */
    .gsap-bloom{ font-style: italic; }

    /* opener (mirrored, keep word intact) */
    .mirror-wrap{ display:grid; grid-template-columns:1fr auto 1fr; gap:1rem; align-items:center; margin:0 0 1rem; }
    .mirror-sep{ width:1px; background:rgba(0,0,0,.08); height:1.4em; }
    .opener{ white-space:nowrap; }
    .mirrored{ transform:scaleX(-1); opacity:.5; }

    /* “just fillers” burst */
    .burst-line{ display:inline-block; }
    .burst-line .char{ transform-origin:center; }

    /* droop */
    .droop .char{ transform-origin: top center; }

    /* thiccer / lifter / fitter */
    .thicker{ font-weight:600; display:inline-block; }
    .lifter{ display:inline-block; }
    .thinner{ font-weight:400; display:inline-block; }

    /* very slow float (bath/wrinkling) */
    .slow-float{ display:inline-block; }

    /* sidenotes */
    .marginnote{}
    .note-media{ width:240px; max-width:90vw; }
    .note-media video{ width:100%; height:auto; display:block; border-radius:10px; }

    /* final sidenote (checkbox-driven show/hide) — use inline so Tufte float rules apply */
    #sn-final + .final-note{ display:none; }
    #sn-final:checked + .final-note{ display:inline; }
    .pc-trigger{ text-decoration: underline; text-decoration-thickness:.06em; cursor:pointer; }

    .back{ margin:3rem 0 4rem; font-size:.95rem; }
    .back a{ border-bottom:1px solid rgba(0,0,0,.25); text-decoration:none; }
    .back a:hover{ border-bottom-color:#000; }

    @media (max-width:640px){
      .mirror-wrap{ grid-template-columns:1fr; gap:.25rem; }
      .mirror-sep{ display:none; }
      .mirrored{ opacity:.35; }
    }

    /* ===== Scroll-fill overlay ===== */
    .poem-wrap{ position:relative; }
    .poem-base{ color:#9a9a9a; }           /* grey base layer */
    .poem-fill-clip{
      position:absolute; inset:0;
      overflow:hidden;    /* mask */
      height:0%;          /* JS animates 0 → 100% */
      pointer-events:none;
    }
    .poem-fill{ color:var(--ink); }
    /* Don’t render sidenote UI in the overlay copy */
    .poem-fill .marginnote,
    .poem-fill .margin-toggle,
    .poem-fill input[type="checkbox"]{ display:none !important; }
  </style>
</head>
<body>
  <main class="pi-tufte">
    <!-- ===== Scroll-fill wrapper ===== -->
    <div class="poem-wrap" id="poemWrap">
      <!-- Base (interactive) layer -->
      <article class="poem poem-base" id="poemBase">

        <!-- 10 blank lines at the beginning -->
        <p class="reveal" aria-hidden="true" style="line-height:1.6">
          <br><br><br><br><br><br><br><br><br><br>
        </p>

        <!-- Mirrored opener -->
        <div class="mirror-wrap reveal">
          <p class="opener">there are just too many reflections</p>
          <div class="mirror-sep" aria-hidden="true"></div>
          <p class="opener mirrored">there are just too many reflections</p>
        </div>

        <!-- Stanza 1 -->
        <p class="reveal">
          <span class="line gsap-bloom per-char">it used to be only in bathrooms,</span><br>
          <span class="line gsap-bloom per-char">the occasional hallway, or a</span><br>
          <span class="line gsap-bloom per-char">fancy bedroom—we see too much</span><br>
          <span class="line gsap-bloom per-char">of myself, everywhere, all the time—</span><br>
          <span class="line">at least, mirrors used to contain light</span><br>
          <span class="line">now they carry hydrocarbon stains</span>
        </p>

        <br><br>

        <!-- Stanza 2 -->
        <p class="reveal">
          <span class="line gsap-bloom per-char">maybe I should take off my clothes</span><br>
          <span class="line gsap-bloom per-char">and perhaps you’d like me better</span><br>
          <span class="line">terrified to grow old but no filters</span><br>
          <span class="line"><span class="burst-line per-char">just fillers</span>: glycerin and matrixyl</span><br>
          <span class="line">argireline solutions and caffeine</span><br>
          <span class="line">organic cold-pressed rose hip oil</span>

          <!-- Product sidenote #1 with video -->
          <label for="sn-1" class="margin-toggle sidenote-number"></label>
          <input type="checkbox" id="sn-1" class="margin-toggle"/>
          <span class="marginnote">
            <div class="note-media">
              <video
                src="https://cdn.media.amplience.net/v/deciem/desktop_loopha_July2025/mp4_720p"
                muted
                playsinline
                autoplay
                loop
                preload="metadata"
              ></video>
            </div>
          </span>
        </p>

        <br><br>

        <!-- Stanza 3 -->
        <p class="reveal">
          <span class="line droop per-char">none of it will save my sagging skin</span><br>
          <span class="line gsap-bloom per-char">although maybe if we just keep buying</span><br>
          <span class="line gsap-bloom per-char">and staring at the vials and dispensers</span><br>
          <span class="line gsap-bloom per-char">on the shelves, the reflections change</span><br>
          <span class="line gsap-bloom per-char">not ours, but the ones in my brain</span><br>
          <span class="line gsap-bloom per-char">rewilding pathways to youth within</span>
        </p>

        <br><br>

        <!-- Stanza 4 -->
        <p class="reveal">
          <span class="line slow-float">why would I take a long bath and risk</span><br>
          <span class="line slow-float">wrinkling everything, on purpose?</span><br>
          <span class="line">
            <span class="thicker">thiccer,</span>
            <span class="lifter">lifter,</span>
            <span class="thinner">fitter,</span>
            <span> triple-action,</span>
          </span><br>
          <span class="line">day-and-night serums, cleansers,</span>

          <!-- Product sidenote #2 with video -->
          <label for="sn-2" class="margin-toggle sidenote-number"></label>
          <input type="checkbox" id="sn-2" class="margin-toggle"/>
          <span class="marginnote">
            <div class="note-media">
              <video
                src="https://cdn.media.amplience.net/v/deciem/D50285_LipExfoliator_Homepage_Desktop/mp4_720p"
                muted
                playsinline
                autoplay
                loop
                preload="metadata"
              ></video>
            </div>
          </span>

          <br>
          <!-- Force same size as the rest to avoid any Tufte side-effects -->
          <span class="line">exfoliators, moisturising suspensions,</span><br>
          <span class="line">organic cold-pressed Moroccan argan oil</span>
        </p>

        <br><br>

        <!-- Final couplet + click-to-reveal sidenote with autoplay video -->
        <p class="reveal">
          <span class="line"><span id="pc-trigger" class="pc-trigger">‘Postmodern Cynicism’</span> exists only online,</span><br>
          <span class="line">you should go on his Facebook sometime</span>

          <!-- Hidden toggle + sidenote (appears on click in right-hand margin) -->
          <input type="checkbox" id="sn-final" class="margin-toggle" />
          <span class="marginnote final-note">
            <div style="margin-top:.25rem;">
              <iframe id="final-yt"
                width="300" height="169"
                title="YouTube video player" frameborder="0"
                allow="autoplay; encrypted-media; picture-in-picture; web-share"
                allowfullscreen
                data-src="https://www.youtube.com/embed/Do7B74dyEVs?autoplay=1&mute=1&controls=0&playsinline=1&rel=0">
              </iframe>
            </div>
          </span>
        </p>

        <!-- 12 blank lines at the end -->
        <p class="reveal" aria-hidden="true" style="line-height:1.6">
          <br><br><br><br><br><br><br><br><br><br><br><br>
        </p>
      </article>
      <!-- Overlay (auto-cloned) goes here -->
    </div>
  </main>

  <script>
    if (typeof gsap !== 'undefined' && typeof ScrollTrigger !== 'undefined') {
      gsap.registerPlugin(ScrollTrigger);
    }

    /* ---------- Scroll-fill overlay ---------- */
    (function(){
      var wrap = document.getElementById('poemWrap');
      var base = document.getElementById('poemBase');
      if (!wrap || !base) return;

      var clip = document.createElement('div');
      clip.className = 'poem-fill-clip';

      var fill = base.cloneNode(true);
      fill.classList.remove('poem-base');
      fill.classList.add('poem', 'poem-fill');
      fill.removeAttribute('id');

      // remove IDs + sidenote UI in overlay
      var withId = fill.querySelectorAll('[id]');
      for (var i=0;i<withId.length;i++) withId[i].removeAttribute('id');
      var ui = fill.querySelectorAll('.marginnote, .margin-toggle, input[type="checkbox"]');
      for (i=0;i<ui.length;i++) ui[i].parentNode.removeChild(ui[i]);

      clip.appendChild(fill);
      wrap.appendChild(clip);

      var reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      function clamp(v,a,b){ return Math.min(b, Math.max(a,v)); }
      function updateFill(){
        if (reduce) { clip.style.height = '100%'; return; }
        var r = wrap.getBoundingClientRect();
        var vh = window.innerHeight || 1;
        var total = r.height + vh;
        var p = clamp((vh - r.top) / total, 0, 1);
        clip.style.height = (p*100).toFixed(2) + '%';
      }
      updateFill();
      window.addEventListener('scroll', updateFill, {passive:true});
      window.addEventListener('resize', updateFill);
    })();

    /* ---------- per-char splitter for bloom/droop/burst lines ---------- */
    (function(){
      function splitCharsIn(root){
        var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
          acceptNode:function(n){ return /\S/.test(n.nodeValue) ? NodeFilter.FILTER_ACCEPT : NodeFilter.REJECT; }
        });
        var nodes = [], current;
        while ((current = walker.nextNode())) nodes.push(current);
        nodes.forEach(function(node){
          var parent = node.parentElement;
          if (parent && (parent.closest('.marginnote') || parent.closest('label') || parent.closest('input'))) return;
          var frag = document.createDocumentFragment();
          for (var i=0;i<node.nodeValue.length;i++){
            var ch = node.nodeValue[i];
            if (ch === ' '){ frag.appendChild(document.createTextNode(' ')); continue; }
            var span = document.createElement('span'); span.className='char'; span.textContent=ch;
            frag.appendChild(span);
          }
          node.parentNode.replaceChild(frag, node);
        });
      }
      var per = document.querySelectorAll('.per-char');
      for (var i=0;i<per.length;i++) splitCharsIn(per[i]);
    })();

    /* ---------- GSAP animations (only if available) ---------- */
    if (typeof ScrollTrigger !== 'undefined') {
      /* reveal-on-scroll (scrubbed per block) */
      document.querySelectorAll('.reveal').forEach(function(el){
        var chars = el.querySelectorAll('.char');
        var tl = gsap.timeline({
          scrollTrigger:{ trigger: el, start:"top 85%", end:"bottom 60%", scrub:true }
        });
        if (chars.length){
          tl.fromTo(chars,{opacity:0, y:8, filter:'blur(1px)'},{opacity:1, y:0, filter:'blur(0px)', stagger:{each:0.01, from:'start'}});
        } else {
          tl.fromTo(el,{opacity:0, y:8},{opacity:1, y:0});
        }
      });

      /* mirrored opener faint fade */
      (function(){
        var wrap = document.querySelector('.mirror-wrap');
        if(!wrap) return;
        gsap.to(wrap.querySelectorAll('.opener'), {
          opacity: 0.15, duration: 1.6,
          scrollTrigger:{ trigger: wrap, start:"top 70%", end:"bottom 40%", scrub:true }
        });
      })();

      /* “just fillers” balloon burst */
      (function(){
        var line = document.querySelector('.burst-line');
        if(!line) return;
        var burstDone = false;
        function runBurst(){
          if(burstDone) return;
          burstDone = true;
          var chars = line.querySelectorAll('.char');
          var tl = gsap.timeline();
          tl.to(chars, {color:"var(--bloom-grey)", duration:0.25, ease:"power2.out"})
            .to(chars, {scale:2.4, duration:0.5, ease:"back.out(2)"}, "<")
            .to(chars, {
              duration:0.7, opacity:0,
              rotate:function(){ return gsap.utils.random(-35,35); },
              x:function(){ return gsap.utils.random(-40,40); },
              y:function(){ return gsap.utils.random(-60,-20); },
              ease:"power2.in"
            }, ">-0.05");
        }
        line.addEventListener('mouseenter', runBurst);
        line.addEventListener('click', runBurst);
      })();

      /* droop */
      (function(){
        var droop = document.querySelector('.droop');
        if(!droop) return;
        var chars = droop.querySelectorAll('.char');
        ScrollTrigger.create({
          trigger: droop, start:"top 85%", once:true,
          onEnter:function(){
            var n = chars.length, center = (n-1)/2;
            chars.forEach(function(ch, i){
              var dist = Math.abs(i-center);
              var drop = 14 * (1 - (dist/(center || 1))) + gsap.utils.random(-2,2);
              gsap.to(ch, { y: drop, rotate: gsap.utils.random(-2,2), duration: 1.25, ease: "sine.out", delay: i*0.005 });
            });
          }
        });
      })();

      /* slow float for the two bath/wrinkling lines */
      document.querySelectorAll('.slow-float').forEach(function(line){
        gsap.to(line, {
          y: -6,
          duration: 12,
          yoyo: true,
          repeat: -1,
          ease: "sine.inOut",
          scrollTrigger:{ trigger: line, start:"top 90%", end:"bottom 50%", toggleActions:"play pause resume pause" }
        });
      });

      /* thiccer / lifter / fitter */
      (function(){
        var any = document.querySelector('.thicker');
        if(!any) return;
        var stanza = any.closest('p');
        if(!stanza) return;
        ScrollTrigger.create({
          trigger: stanza, start:"top 85%", once:true,
          onEnter:function(){
            gsap.to('.thicker', { fontWeight: 900, duration: .5, ease: 'power2.out' });
            gsap.to('.lifter', { y: -8, duration: .6, ease: 'sine.out' });
            gsap.to('.thinner', { fontWeight: 200, duration: .5, ease: 'power2.out' });
          }
        });
      })();

      /* click-to-reveal final sidenote + autoplay */
      (function(){
        var trigger = document.getElementById('pc-trigger');
        var checkbox = document.getElementById('sn-final');
        var yt = document.getElementById('final-yt');
        if(!trigger || !checkbox || !yt) return;
        function showNote(){
          if (!checkbox.checked){
            checkbox.checked = true;
            var note = checkbox.nextElementSibling; // .final-note (marginnote)
            if (note) gsap.fromTo(note, {opacity:0, y:8}, {opacity:1, y:0, duration:0.5, ease:"power2.out"});
            if (!yt.src) yt.src = yt.getAttribute('data-src'); // lazy-load + autoplay
          }
        }
        trigger.addEventListener('click', showNote);
        trigger.addEventListener('keydown', function(e){ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); showNote(); }});
      })();

      /* bloom (light grey) — only on marked lines */
      (function(){
        var blooms = [].slice.call(document.querySelectorAll('.gsap-bloom'));
        function bloom(line){
          var chars = line.querySelectorAll('.char');
          if (!chars.length) return;
          gsap.killTweensOf(chars);
          gsap.to(chars, {
            scale: 1.24,
            color: 'var(--bloom-grey)',
            duration: 0.6,
            yoyo: true,
            repeat: 1,
            ease: 'power1.inOut',
            stagger: 0.04
          });
        }
        blooms.forEach(function(p){
          p.tabIndex = 0;
          p.addEventListener('pointerenter', function(){ bloom(p); });
          p.addEventListener('click', function(){ bloom(p); });
          p.addEventListener('focus', function(){ bloom(p); });
        });
      })();

      window.addEventListener('load', function(){ try{ ScrollTrigger.refresh(); }catch(e){} });
    }
  </script>
</body>
    <!-- Back link -->
  <p style="margin:0.5rem 0 1rem"><a href="../">← back to poems</a></p>
</html>
