<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ostende-2</title>

  <!-- Tufte CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tufte-css/1.8.0/tufte.min.css"/>

  <style>
    /* Layout + poem type */
    .pi-tufte { max-width: 70ch; margin: 0 auto; padding: 1.2rem 0 4rem; }
    .poem-wrap { position: relative; }
    .poem { font-size: 0.50rem; line-height: 1.5; }
    .poem p { margin: 0.15rem 0; }
    .pi-ital { font-style: italic; }

    /* Scroll-fill: base (grey) + overlay (white) */
    .poem-base { color: #9a9a9a; }
    .poem-fill {
      position: absolute; inset: 0;
      color: #fff;
      pointer-events: none;            /* keep interactions on the base layer */
      --reveal: 0;                     /* 0..1 set by JS */
      -webkit-mask-image: linear-gradient(to bottom,
        rgba(0,0,0,1) 0%,
        rgba(0,0,0,1) calc(var(--reveal) * 100%),
        rgba(0,0,0,0) calc(var(--reveal) * 100%));
      mask-image: linear-gradient(to bottom,
        rgba(0,0,0,1) 0%,
        rgba(0,0,0,1) calc(var(--reveal) * 100%),
        rgba(0,0,0,0) calc(var(--reveal) * 100%));
    }
    .poem-fill .sidenote,
    .poem-fill .margin-toggle,
    .poem-fill input[type="checkbox"] { display: none !important; }

    /* Reveal-on-scroll baseline */
    .reveal { opacity: 0; transform: translateY(12px); transition: opacity .6s ease, transform .6s ease; }
    .revealed { opacity: 1; transform: none; }

    /* Character-splitting output */
    .char { display:inline-block; will-change: transform, color; }

    /* BLOOM: CSS keyframes (scale + turquoise then back) */
    @keyframes bloomKF {
      0%   { transform: scale(1);   color: inherit; }
      50%  { transform: scale(1.24); color: #40E0D0; }
      100% { transform: scale(1);   color: inherit; }
    }
    .do-bloom .char {
      animation: bloomKF .75s ease-in-out both;
      animation-delay: calc(var(--i, 0) * 0.04s);
    }

    /* FINAL WAVE (triggered by adding .wavego to #line-50) */
    @keyframes charWaveKF {
      0%,100% { transform: translateY(0); }
      50%     { transform: translateY(-12px); }
    }
    @keyframes driftKF {
      from { transform: translate(0,0) rotate(0deg); opacity: 1; }
      to   { transform: translate(90vw, 40vh) rotate(5deg); opacity: 0; }
    }
    @keyframes bobKF {
      0%,100% { transform: translateY(0); }
      50%     { transform: translateY(12px); }
    }
    #line-50.wavego { 
      animation: driftKF 18s ease-in-out forwards, bobKF 1.8s ease-in-out 10 alternate;
    }
    #line-50.wavego .char {
      animation: charWaveKF .8s ease-in-out 15 alternate;
      animation-delay: calc(var(--i, 0) * 0.08s);
    }

    /* Audio word */
    .pi-audio { text-decoration: underline; cursor: pointer; }
    .pi-audio[aria-pressed="true"] { text-decoration: underline dotted; }

    /* Optional subtitle styling */
    .pi-sub { font-size: .65rem; margin: -.2rem 0 1rem; color:#666; font-style: italic; }
    .pi-sub img { max-width: 100%; height: auto; opacity: .95; display:block; }
  </style>

  <!-- YouTube IFrame API (for audio click) -->
  <script async src="https://www.youtube.com/iframe_api"></script>
</head>
<body>

<article class="pi-tufte">
  <h1 style="font-size:0.9rem;margin:0 0 0.4rem;">Ostende-2</h1>
  <!-- Subtitle with image in a sidenote -->
  <p class="pi-sub">
    — notes and map
    <label for="sn-img" class="margin-toggle sidenote-number"></label>
    <input type="checkbox" id="sn-img" class="margin-toggle"/>
    <span class="sidenote">
      <img src="./COLLEGE-PETRUS-EN-PAULUS-HISTORIEK-vetsigingsplaatsen.jpeg" alt="Historic plan of Ostend (map)"/>
    </span>
  </p>

  <div class="poem-wrap" id="poemWrap">
    <!-- Baseline (interactive) layer -->
    <div class="poem poem-base" id="poemBase">

      <!-- 1–4 -->
      <p class="reveal">les galeries vénitiennes</p>
      <p class="reveal">garde une jardin Japonais</p>
      <p class="reveal">devant un puits artésien,
        <label for="sn-1" class="margin-toggle sidenote-number"></label>
        <input type="checkbox" id="sn-1" class="margin-toggle" />
        <span class="sidenote">the Venetian galleries<br>hide a Japanese garden<br>in front of an artesian well</span>
      </p>
      <p class="pi-ital reveal">Palais des Thermes:</p>

      <br><br>

      <!-- 5–10 (bloom targets) -->
      <p class="pi-ital reveal">~</p>
      <p class="gsap-bloom reveal">the gods are vulnerable</p>
      <p class="gsap-bloom reveal">still so fertile, so soft</p>
      <p class="gsap-bloom reveal">yet they’re dying out</p>
      <p class="gsap-bloom reveal">in front of our eyes</p>
      <p class="pi-ital reveal">~</p>

      <br><br>

      <!-- 11–18 -->
      <p class="reveal">art-deco exuberante</p>
      <p class="reveal">frescos, des styles</p>
      <p class="reveal">architecturaux</p>
      <p class="reveal">classiques conservatrices</p>
      <p class="reveal">culminant dans une</p>
      <p class="reveal">forme éclectique</p>
      <p class="reveal">avec des accents</p>
      <p class="reveal">néo-Louis XV
        <label for="sn-2" class="margin-toggle sidenote-number"></label>
        <input type="checkbox" id="sn-2" class="margin-toggle" />
        <span class="sidenote">exuberant art deco<br>frescoes, with styles so<br>architecturally<br>classical conservative<br>culminating in an<br>eclectic form<br>with neo-accents<br>of Louis XV</span>
      </p>

      <br><br>

      <!-- 19–26 -->
      <p class="reveal">mes pours les mecs</p>
      <p class="reveal">locales, c’était</p>
      <p class="pi-ital reveal">de witten ooljefant</p>
      <p class="reveal">chère, une modalité</p>
      <p class="reveal">pour les riches</p>
      <p class="reveal">les bourgeouis,</p>
      <p class="reveal">pas nous, le peuple</p>
      <p class="reveal">ordinaire, les marchants
        <label for="sn-3" class="margin-toggle sidenote-number"></label>
        <input type="checkbox" id="sn-3" class="margin-toggle" />
        <span class="sidenote">but for the lads,<br>the locals, it was<br>“the White Elephant”<br>expensive, a luxury<br>for the rich,<br>the bourgeoisie,<br>not us, the people,<br>the merchants</span>
      </p>

      <br><br>

      <!-- 27–34 -->
      <p class="reveal">ma ècole, une palais</p>
      <p class="reveal">napoleonique</p>
      <p class="pi-ital reveal">althans dat is wat</p>
      <p class="pi-ital reveal">ze ons hadden</p>
      <p class="pi-ital reveal">verteld, al lijkt daar</p>
      <p class="pi-ital reveal">weinig echt van aan</p>
      <p class="reveal">avec des anciens</p>
      <p class="reveal">comme Ensor
        <label for="sn-4" class="margin-toggle sidenote-number"></label>
        <input type="checkbox" id="sn-4" class="margin-toggle" />
        <span class="sidenote">my school, a palace<br>in Napoleon-style<br>at least that's what<br>they told us,<br>although there seems to be<br>little truth in it<br>with alumni<br>like James Ensor (the painter)</span>
      </p>

      <br><br>

      <!-- 35–40 (bloom targets) -->
      <p class="pi-ital reveal">~</p>
      <p class="gsap-bloom reveal">left with only memories</p>
      <p class="gsap-bloom reveal">of roses, his beard, the scent</p>
      <p class="gsap-bloom reveal">of lilacs, wild raspberries,</p>
      <p class="gsap-bloom reveal">rumour of a long-eared owl</p>
      <p class="pi-ital reveal">~</p>

      <br><br>

      <!-- 41–45 -->
      <p class="reveal">(en fait il n'y est</p>
      <p class="reveal">resté que deux ans)</p>
      <p class="reveal">comme Spilliaert</p>
      <p class="pi-ital reveal">excentrieke ziener van</p>
      <p class="pi-ital reveal">een vreemde realiteit
        <label for="sn-5" class="margin-toggle sidenote-number"></label>
        <input type="checkbox" id="sn-5" class="margin-toggle" />
        <span class="sidenote">(in fact, he only stayed there<br>for two years)<br>like Léon Spilliaert (another painter)<br>eccentric seer of<br>a strange reality</span>
      </p>

      <br><br>

      <!-- 46–49 -->
      <p class="reveal">fort militaire polygonal</p>
      <p class="reveal">au bord de la mer</p>
      <p class="reveal">à l'infini</p>
      <p class="reveal">avant qu'il ne soit fini
        <label for="sn-6" class="margin-toggle sidenote-number"></label>
        <input type="checkbox" id="sn-6" class="margin-toggle" />
        <span class="sidenote">polygonal military fort<br>by the sea<br>into infinity<br>before it is all gone</span>
      </p>

      <!-- Six breaks before final line -->
      <br><br><br><br><br><br>

      <!-- 50 (final wave + audio) -->
      <p id="line-50" class="pi-ital reveal" tabindex="0">
        sehnsucht? <span id="pi-zeezucht" class="pi-audio" role="button" aria-pressed="false" tabindex="0">zeezucht</span>
      </p>
    </div>
    <!-- JS will insert .poem-fill clone here -->
  </div>

  <div id="yt-audio-holder" style="position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;"></div>
</article>

<script>
(() => {
  const wrap = document.getElementById('poemWrap');
  const base = document.getElementById('poemBase');
  const prefersReduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  /* --- Overlay clone for scroll-fill (white) --- */
  const fill = base.cloneNode(true);
  fill.classList.remove('poem-base'); fill.classList.add('poem-fill');
  fill.removeAttribute('id');
  // Remove duplicate IDs and sidenote controls from overlay
  fill.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));
  fill.querySelectorAll('.sidenote, .margin-toggle, input[type="checkbox"]').forEach(el => el.remove());
  wrap.appendChild(fill);

  /* --- Scroll-fill progress: sets --reveal on wrap --- */
  function clamp(v, a, b) { return Math.min(b, Math.max(a, v)); }
  function updateReveal() {
    if (prefersReduce) { wrap.style.setProperty('--reveal', 1); return; }
    const r = wrap.getBoundingClientRect(), vh = window.innerHeight || 1;
    const total = r.height + vh; // enter to leave
    const p = clamp((vh - r.top) / total, 0, 1);
    wrap.style.setProperty('--reveal', p.toFixed(4));
  }
  updateReveal();
  addEventListener('scroll', updateReveal, { passive:true });
  addEventListener('resize', updateReveal);

  /* --- Tiny character splitter for bloom + final line --- */
  function splitCharsIn(el) {
    const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, {
      acceptNode(n) { return /\S/.test(n.nodeValue) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT; }
    });
    const nodes = [];
    while (walker.nextNode()) nodes.push(walker.currentNode);
    nodes.forEach(node => {
      const parent = node.parentElement;
      if (parent && (parent.closest('.sidenote') || parent.closest('label') || parent.closest('input'))) return;
      const frag = document.createDocumentFragment();
      let i = 0;
      for (const ch of node.nodeValue) {
        if (ch === ' ') { frag.appendChild(document.createTextNode(' ')); continue; }
        const span = document.createElement('span');
        span.className = 'char'; span.textContent = ch;
        span.style.setProperty('--i', i++); // index for stagger
        frag.appendChild(span);
      }
      node.parentNode.replaceChild(frag, node);
    });
  }
  base.querySelectorAll('.gsap-bloom, #line-50').forEach(splitCharsIn);
  fill.querySelectorAll('.gsap-bloom').forEach(splitCharsIn);

  /* --- Reveal baseline lines on scroll (no libs) --- */
  const rev = base.querySelectorAll('.reveal');
  if (!prefersReduce && 'IntersectionObserver' in window) {
    const io = new IntersectionObserver((entries) => {
      entries.forEach(({target, isIntersecting}) => {
        if (isIntersecting) { target.classList.add('revealed'); io.unobserve(target); }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -10% 0px' });
    rev.forEach(el => io.observe(el));
  } else {
    rev.forEach(el => el.classList.add('revealed'));
  }

  /* --- BLOOM on scroll: add .do-bloom once when visible --- */
  const bloomTargets = base.querySelectorAll('.gsap-bloom');
  if (!prefersReduce && 'IntersectionObserver' in window) {
    const seen = new WeakSet();
    const bio = new IntersectionObserver((entries) => {
      entries.forEach(({target, isIntersecting}) => {
        if (!isIntersecting || seen.has(target)) return;
        seen.add(target);
        target.classList.add('do-bloom');
        // Also scale the overlay copy’s chars (same index)
        const idx = Array.from(bloomTargets).indexOf(target);
        const overlay = fill.querySelectorAll('.gsap-bloom')[idx];
        if (overlay) overlay.classList.add('do-bloom');
        bio.unobserve(target);
      });
    }, { threshold: 0.35 });
    bloomTargets.forEach(el => bio.observe(el));
  }

  /* --- FINAL wave (hover/tap) with CSS animations --- */
  const l50 = document.getElementById('line-50');
  if (l50) {
    const startWave = (e) => {
      if (prefersReduce) return;
      if (e && e.target && e.target.closest && e.target.closest('#pi-zeezucht')) return; // let audio handle itself
      l50.classList.remove('wavego'); // restart if needed
      // force reflow to restart animation if already running
      void l50.offsetWidth;
      l50.classList.add('wavego');
      // remove the class after animations end so it can be re-triggered
      setTimeout(() => l50.classList.remove('wavego'), 18500);
    };
    l50.addEventListener('pointerenter', startWave);
    l50.addEventListener('click', startWave);
  }

  /* --- YouTube audio click with small fade --- */
  let player = null, ready = false, playing = false;
  const trigger = document.getElementById('pi-zeezucht');

  function fadeVolume(target, ms, done){
    if (!ready || !player || !player.setVolume) return done && done();
    const start = player.getVolume ? player.getVolume() : 0;
    const t0 = performance.now();
    function step(now){
      const t = Math.min(1, (now - t0) / ms);
      const v = Math.round(start + (target - start) * t);
      player.setVolume(v);
      if (t < 1) requestAnimationFrame(step); else done && done();
    }
    requestAnimationFrame(step);
  }

  if (trigger) {
    const play = () => { if (!ready) return; try { player.setVolume(0); player.playVideo(); } catch(e){} trigger.setAttribute('aria-pressed','true'); playing = true; fadeVolume(60, 900); };
    const pause = () => { if (!ready) return; fadeVolume(0, 700, () => { try { player.pauseVideo(); } catch(e){} }); trigger.setAttribute('aria-pressed','false'); playing = false; };
    const toggle = () => (playing ? pause() : play());
    trigger.addEventListener('click', e => { e.preventDefault(); toggle(); });
    trigger.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); } });

    const prev = window.onYouTubeIframeAPIReady;
    window.onYouTubeIframeAPIReady = function(){
      try { if (typeof prev === 'function') prev(); } catch(e){}
      player = new YT.Player('yt-audio-holder', {
        height:'1', width:'1', videoId:'aeIzNh35VBA',
        playerVars:{ controls:0, modestbranding:1, playsinline:1, origin:location.origin },
        events:{ onReady: () => { ready = true; try { player.setVolume(0); } catch(e){} } }
      });
    };
    if (window.YT && YT.Player) window.onYouTubeIframeAPIReady();
  }
})();
</script>

</body>
</html>
